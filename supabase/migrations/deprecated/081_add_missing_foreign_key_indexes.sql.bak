-- Migration: Add Missing Foreign Key Indexes
-- Description: Adds indexes for all unindexed foreign keys identified by Supabase Performance Advisor
-- This improves query performance for JOIN operations and foreign key constraint checks
-- Date: 2025-10-19

-- ============================================================================
-- AGREEMENTS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_agreements_approved_by 
  ON public.agreements(approved_by);

CREATE INDEX IF NOT EXISTS idx_agreements_created_by 
  ON public.agreements(created_by);

-- ============================================================================
-- AI RECOMMENDATIONS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_ai_recommendations_reviewed_by 
  ON public.ai_recommendations(reviewed_by);

-- ============================================================================
-- ANALYTICS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_analytics_views_created_by 
  ON public.analytics_views(created_by);

CREATE INDEX IF NOT EXISTS idx_analytics_views_data_source_id 
  ON public.analytics_views(data_source_id);

-- ============================================================================
-- APPROVAL SYSTEM
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_approval_chains_created_by 
  ON public.approval_chains(created_by);

CREATE INDEX IF NOT EXISTS idx_approval_chains_escalation_user_id 
  ON public.approval_chains(escalation_user_id);

CREATE INDEX IF NOT EXISTS idx_approval_requests_approved_by 
  ON public.approval_requests(approved_by);

CREATE INDEX IF NOT EXISTS idx_approval_requests_current_approver 
  ON public.approval_requests(current_approver);

CREATE INDEX IF NOT EXISTS idx_approval_requests_requested_by 
  ON public.approval_requests(requested_by);

CREATE INDEX IF NOT EXISTS idx_approval_workflows_created_by 
  ON public.approval_workflows(created_by);

-- ============================================================================
-- ASSETS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_asset_maintenance_performed_by 
  ON public.asset_maintenance(performed_by);

CREATE INDEX IF NOT EXISTS idx_asset_maintenance_vendor_id 
  ON public.asset_maintenance(vendor_id);

CREATE INDEX IF NOT EXISTS idx_asset_transactions_performed_by 
  ON public.asset_transactions(performed_by);

CREATE INDEX IF NOT EXISTS idx_asset_transactions_from_location_id 
  ON public.asset_transactions(from_location_id);

CREATE INDEX IF NOT EXISTS idx_asset_transactions_to_location_id 
  ON public.asset_transactions(to_location_id);

CREATE INDEX IF NOT EXISTS idx_assets_created_by 
  ON public.assets(created_by);

-- ============================================================================
-- FINANCE MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_automated_financial_rules_created_by 
  ON public.automated_financial_rules(created_by);

CREATE INDEX IF NOT EXISTS idx_budget_scenarios_created_by 
  ON public.budget_scenarios(created_by);

CREATE INDEX IF NOT EXISTS idx_budget_variance_tracking_analyzed_by 
  ON public.budget_variance_tracking(analyzed_by);

CREATE INDEX IF NOT EXISTS idx_budget_variance_tracking_budget_line_item_id 
  ON public.budget_variance_tracking(budget_line_item_id);

CREATE INDEX IF NOT EXISTS idx_cash_flow_projections_created_by 
  ON public.cash_flow_projections(created_by);

CREATE INDEX IF NOT EXISTS idx_corporate_cards_created_by 
  ON public.corporate_cards(created_by);

CREATE INDEX IF NOT EXISTS idx_corporate_cards_policy_id 
  ON public.corporate_cards(policy_id);

-- ============================================================================
-- PROCUREMENT MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_bids_production_id 
  ON public.bids(production_id);

-- ============================================================================
-- BOOKINGS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_bookings_created_by 
  ON public.bookings(created_by);

-- ============================================================================
-- CHECKLISTS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_checklist_items_completed_by 
  ON public.checklist_items(completed_by);

CREATE INDEX IF NOT EXISTS idx_checklist_templates_created_by 
  ON public.checklist_templates(created_by);

CREATE INDEX IF NOT EXISTS idx_checklists_template_id 
  ON public.checklists(template_id);

-- ============================================================================
-- COMMENTS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_comments_parent_id 
  ON public.comments(parent_id);

-- ============================================================================
-- INVENTORY MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_count_line_items_counted_by 
  ON public.count_line_items(counted_by);

-- ============================================================================
-- CUSTOM FIELDS & METRICS
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_custom_fields_workspace_id 
  ON public.custom_fields(workspace_id);

CREATE INDEX IF NOT EXISTS idx_custom_metrics_created_by 
  ON public.custom_metrics(created_by);

-- ============================================================================
-- DATA SOURCES
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_data_sources_created_by 
  ON public.data_sources(created_by);

-- ============================================================================
-- DEALS & ESTIMATES
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_deal_financial_terms_created_by 
  ON public.deal_financial_terms(created_by);

CREATE INDEX IF NOT EXISTS idx_estimates_client_contact_id 
  ON public.estimates(client_contact_id);

CREATE INDEX IF NOT EXISTS idx_estimates_converted_to_contract_id 
  ON public.estimates(converted_to_contract_id);

-- ============================================================================
-- EXPENSES MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_expense_items_expense_report_id 
  ON public.expense_items(expense_report_id);

CREATE INDEX IF NOT EXISTS idx_expense_reports_approved_by 
  ON public.expense_reports(approved_by);

CREATE INDEX IF NOT EXISTS idx_expense_reports_production_id 
  ON public.expense_reports(production_id);

CREATE INDEX IF NOT EXISTS idx_expense_reports_submitted_by 
  ON public.expense_reports(submitted_by);

CREATE INDEX IF NOT EXISTS idx_expense_reports_workspace_id 
  ON public.expense_reports(workspace_id);

-- ============================================================================
-- FILES MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_file_categories_parent_id 
  ON public.file_categories(parent_id);

CREATE INDEX IF NOT EXISTS idx_file_folders_created_by 
  ON public.file_folders(created_by);

CREATE INDEX IF NOT EXISTS idx_file_versions_uploaded_by 
  ON public.file_versions(uploaded_by);

CREATE INDEX IF NOT EXISTS idx_files_uploaded_by 
  ON public.files(uploaded_by);

-- ============================================================================
-- FINANCIAL TRANSACTIONS
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_financial_transactions_approved_by 
  ON public.financial_transactions(approved_by);

CREATE INDEX IF NOT EXISTS idx_financial_transactions_budget_line_item_id 
  ON public.financial_transactions(budget_line_item_id);

CREATE INDEX IF NOT EXISTS idx_financial_transactions_created_by 
  ON public.financial_transactions(created_by);

CREATE INDEX IF NOT EXISTS idx_financial_transactions_expense_report_id 
  ON public.financial_transactions(expense_report_id);

CREATE INDEX IF NOT EXISTS idx_financial_transactions_invoice_id 
  ON public.financial_transactions(invoice_id);

CREATE INDEX IF NOT EXISTS idx_financial_transactions_payment_method_id 
  ON public.financial_transactions(payment_method_id);

CREATE INDEX IF NOT EXISTS idx_financial_transactions_purchase_order_id 
  ON public.financial_transactions(purchase_order_id);

-- ============================================================================
-- INVOICES MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_invoice_line_items_invoice_id 
  ON public.invoice_line_items(invoice_id);

CREATE INDEX IF NOT EXISTS idx_invoices_approved_by 
  ON public.invoices(approved_by);

CREATE INDEX IF NOT EXISTS idx_invoices_client_contact_id 
  ON public.invoices(client_contact_id);

CREATE INDEX IF NOT EXISTS idx_invoices_created_by 
  ON public.invoices(created_by);

CREATE INDEX IF NOT EXISTS idx_invoices_production_id 
  ON public.invoices(production_id);

-- ============================================================================
-- JOBS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_job_applications_created_by 
  ON public.job_applications(created_by);

CREATE INDEX IF NOT EXISTS idx_job_applications_reviewed_by 
  ON public.job_applications(reviewed_by);

CREATE INDEX IF NOT EXISTS idx_jobs_created_by 
  ON public.jobs(created_by);

-- ============================================================================
-- LOCATIONS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_location_amenities_created_by 
  ON public.location_amenities(created_by);

CREATE INDEX IF NOT EXISTS idx_location_contacts_created_by 
  ON public.location_contacts(created_by);

CREATE INDEX IF NOT EXISTS idx_location_insurance_created_by 
  ON public.location_insurance(created_by);

CREATE INDEX IF NOT EXISTS idx_location_permits_approved_by 
  ON public.location_permits(approved_by);

CREATE INDEX IF NOT EXISTS idx_location_permits_created_by 
  ON public.location_permits(created_by);

CREATE INDEX IF NOT EXISTS idx_location_photos_uploaded_by 
  ON public.location_photos(uploaded_by);

CREATE INDEX IF NOT EXISTS idx_location_restrictions_created_by 
  ON public.location_restrictions(created_by);

CREATE INDEX IF NOT EXISTS idx_locations_created_by 
  ON public.locations(created_by);

-- ============================================================================
-- MARKETPLACE MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_marketplace_listings_created_by 
  ON public.marketplace_listings(created_by);

CREATE INDEX IF NOT EXISTS idx_marketplace_orders_buyer_id 
  ON public.marketplace_orders(buyer_id);

CREATE INDEX IF NOT EXISTS idx_marketplace_orders_seller_id 
  ON public.marketplace_orders(seller_id);

CREATE INDEX IF NOT EXISTS idx_marketplace_reviews_created_by 
  ON public.marketplace_reviews(created_by);

-- ============================================================================
-- NOTIFICATIONS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_notifications_triggered_by 
  ON public.notifications(triggered_by);

-- ============================================================================
-- PAYMENTS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_payment_methods_created_by 
  ON public.payment_methods(created_by);

CREATE INDEX IF NOT EXISTS idx_payments_approved_by 
  ON public.payments(approved_by);

CREATE INDEX IF NOT EXISTS idx_payments_created_by 
  ON public.payments(created_by);

CREATE INDEX IF NOT EXISTS idx_payments_invoice_id 
  ON public.payments(invoice_id);

CREATE INDEX IF NOT EXISTS idx_payments_payment_method_id 
  ON public.payments(payment_method_id);

-- ============================================================================
-- PEOPLE MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_people_created_by 
  ON public.people(created_by);

CREATE INDEX IF NOT EXISTS idx_person_availability_created_by 
  ON public.person_availability(created_by);

CREATE INDEX IF NOT EXISTS idx_person_certifications_created_by 
  ON public.person_certifications(created_by);

CREATE INDEX IF NOT EXISTS idx_person_documents_uploaded_by 
  ON public.person_documents(uploaded_by);

CREATE INDEX IF NOT EXISTS idx_person_emergency_contacts_created_by 
  ON public.person_emergency_contacts(created_by);

CREATE INDEX IF NOT EXISTS idx_person_equipment_created_by 
  ON public.person_equipment(created_by);

CREATE INDEX IF NOT EXISTS idx_person_notes_created_by 
  ON public.person_notes(created_by);

CREATE INDEX IF NOT EXISTS idx_person_rates_created_by 
  ON public.person_rates(created_by);

-- ============================================================================
-- PRODUCTION MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_production_budgets_approved_by 
  ON public.production_budgets(approved_by);

CREATE INDEX IF NOT EXISTS idx_production_budgets_created_by 
  ON public.production_budgets(created_by);

CREATE INDEX IF NOT EXISTS idx_production_contacts_created_by 
  ON public.production_contacts(created_by);

CREATE INDEX IF NOT EXISTS idx_production_documents_uploaded_by 
  ON public.production_documents(uploaded_by);

CREATE INDEX IF NOT EXISTS idx_production_notes_created_by 
  ON public.production_notes(created_by);

CREATE INDEX IF NOT EXISTS idx_productions_created_by 
  ON public.productions(created_by);

-- ============================================================================
-- PROJECTS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_project_assignments_assigned_by 
  ON public.project_assignments(assigned_by);

CREATE INDEX IF NOT EXISTS idx_project_budgets_approved_by 
  ON public.project_budgets(approved_by);

CREATE INDEX IF NOT EXISTS idx_project_budgets_created_by 
  ON public.project_budgets(created_by);

CREATE INDEX IF NOT EXISTS idx_project_documents_uploaded_by 
  ON public.project_documents(uploaded_by);

CREATE INDEX IF NOT EXISTS idx_project_milestones_created_by 
  ON public.project_milestones(created_by);

CREATE INDEX IF NOT EXISTS idx_project_notes_created_by 
  ON public.project_notes(created_by);

CREATE INDEX IF NOT EXISTS idx_project_risks_created_by 
  ON public.project_risks(created_by);

CREATE INDEX IF NOT EXISTS idx_project_tasks_assigned_by 
  ON public.project_tasks(assigned_by);

CREATE INDEX IF NOT EXISTS idx_project_tasks_created_by 
  ON public.project_tasks(created_by);

CREATE INDEX IF NOT EXISTS idx_projects_created_by 
  ON public.projects(created_by);

-- ============================================================================
-- PURCHASE ORDERS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_purchase_order_line_items_purchase_order_id 
  ON public.purchase_order_line_items(purchase_order_id);

CREATE INDEX IF NOT EXISTS idx_purchase_orders_approved_by 
  ON public.purchase_orders(approved_by);

CREATE INDEX IF NOT EXISTS idx_purchase_orders_created_by 
  ON public.purchase_orders(created_by);

CREATE INDEX IF NOT EXISTS idx_purchase_orders_vendor_contact_id 
  ON public.purchase_orders(vendor_contact_id);

-- ============================================================================
-- REPORTS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_report_schedules_created_by 
  ON public.report_schedules(created_by);

CREATE INDEX IF NOT EXISTS idx_reports_created_by 
  ON public.reports(created_by);

-- ============================================================================
-- RESOURCES MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_resource_bookings_approved_by 
  ON public.resource_bookings(approved_by);

CREATE INDEX IF NOT EXISTS idx_resource_bookings_created_by 
  ON public.resource_bookings(created_by);

CREATE INDEX IF NOT EXISTS idx_resources_created_by 
  ON public.resources(created_by);

-- ============================================================================
-- SHIPMENTS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_shipment_items_shipment_id 
  ON public.shipment_items(shipment_id);

CREATE INDEX IF NOT EXISTS idx_shipments_created_by 
  ON public.shipments(created_by);

CREATE INDEX IF NOT EXISTS idx_shipments_from_location_id 
  ON public.shipments(from_location_id);

CREATE INDEX IF NOT EXISTS idx_shipments_to_location_id 
  ON public.shipments(to_location_id);

-- ============================================================================
-- SPENDING POLICIES MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_spending_policies_created_by 
  ON public.spending_policies(created_by);

-- ============================================================================
-- STOCK MOVEMENTS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_stock_movements_performed_by 
  ON public.stock_movements(performed_by);

-- ============================================================================
-- TAGS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_tag_assignments_assigned_by 
  ON public.tag_assignments(assigned_by);

CREATE INDEX IF NOT EXISTS idx_tags_created_by 
  ON public.tags(created_by);

-- ============================================================================
-- TASKS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_task_assignments_assigned_by 
  ON public.task_assignments(assigned_by);

CREATE INDEX IF NOT EXISTS idx_task_dependencies_created_by 
  ON public.task_dependencies(created_by);

CREATE INDEX IF NOT EXISTS idx_tasks_assigned_by 
  ON public.tasks(assigned_by);

CREATE INDEX IF NOT EXISTS idx_tasks_created_by 
  ON public.tasks(created_by);

-- ============================================================================
-- TIMESHEET MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_timesheet_entries_approved_by 
  ON public.timesheet_entries(approved_by);

CREATE INDEX IF NOT EXISTS idx_timesheets_approved_by 
  ON public.timesheets(approved_by);

-- ============================================================================
-- VENDORS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_vendor_contacts_created_by 
  ON public.vendor_contacts(created_by);

CREATE INDEX IF NOT EXISTS idx_vendor_documents_uploaded_by 
  ON public.vendor_documents(uploaded_by);

CREATE INDEX IF NOT EXISTS idx_vendor_insurance_created_by 
  ON public.vendor_insurance(created_by);

CREATE INDEX IF NOT EXISTS idx_vendor_notes_created_by 
  ON public.vendor_notes(created_by);

CREATE INDEX IF NOT EXISTS idx_vendor_performance_reviewed_by 
  ON public.vendor_performance(reviewed_by);

CREATE INDEX IF NOT EXISTS idx_vendors_created_by 
  ON public.vendors(created_by);

-- ============================================================================
-- WEBHOOKS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_webhook_deliveries_webhook_id 
  ON public.webhook_deliveries(webhook_id);

CREATE INDEX IF NOT EXISTS idx_webhooks_created_by 
  ON public.webhooks(created_by);

-- ============================================================================
-- WORKSPACE MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_workspace_integrations_created_by 
  ON public.workspace_integrations(created_by);

CREATE INDEX IF NOT EXISTS idx_workspace_settings_updated_by 
  ON public.workspace_settings(updated_by);

-- ============================================================================
-- SITE MAPS MODULE
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_site_maps_created_by 
  ON public.site_maps(created_by);

CREATE INDEX IF NOT EXISTS idx_site_maps_location_id 
  ON public.site_maps(location_id);

-- ============================================================================
-- ADDITIONAL MISSING INDEXES FROM LINTER
-- ============================================================================

-- Events module
CREATE INDEX IF NOT EXISTS idx_event_assignments_assigned_by 
  ON public.event_assignments(assigned_by);

CREATE INDEX IF NOT EXISTS idx_event_budgets_approved_by 
  ON public.event_budgets(approved_by);

CREATE INDEX IF NOT EXISTS idx_event_budgets_created_by 
  ON public.event_budgets(created_by);

CREATE INDEX IF NOT EXISTS idx_event_documents_uploaded_by 
  ON public.event_documents(uploaded_by);

CREATE INDEX IF NOT EXISTS idx_event_notes_created_by 
  ON public.event_notes(created_by);

CREATE INDEX IF NOT EXISTS idx_events_created_by 
  ON public.events(created_by);

-- Companies module
CREATE INDEX IF NOT EXISTS idx_companies_created_by 
  ON public.companies(created_by);

CREATE INDEX IF NOT EXISTS idx_company_contacts_created_by 
  ON public.company_contacts(created_by);

CREATE INDEX IF NOT EXISTS idx_company_documents_uploaded_by 
  ON public.company_documents(uploaded_by);

CREATE INDEX IF NOT EXISTS idx_company_notes_created_by 
  ON public.company_notes(created_by);

-- Insights module
CREATE INDEX IF NOT EXISTS idx_insights_created_by 
  ON public.insights(created_by);

-- ============================================================================
-- PERFORMANCE NOTES
-- ============================================================================

-- These indexes will significantly improve:
-- 1. JOIN performance when querying related records
-- 2. Foreign key constraint validation speed
-- 3. CASCADE DELETE/UPDATE operations
-- 4. Query planner optimization for filtered queries
-- 5. Overall application response time for related data fetching

COMMENT ON INDEX idx_agreements_approved_by IS 'Performance: Improves JOIN queries on approved_by foreign key';
COMMENT ON INDEX idx_agreements_created_by IS 'Performance: Improves JOIN queries on created_by foreign key';
COMMENT ON INDEX idx_ai_recommendations_reviewed_by IS 'Performance: Improves JOIN queries on reviewed_by foreign key';
COMMENT ON INDEX idx_analytics_views_created_by IS 'Performance: Improves JOIN queries on created_by foreign key';
COMMENT ON INDEX idx_analytics_views_data_source_id IS 'Performance: Improves JOIN queries on data_source_id foreign key';
